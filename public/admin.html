<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - VPS Manager</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <h1>Admin Panel</h1>

        <div id="loginSection">
            <div class="form-group">
                <label>Admin Secret Key</label>
                <input type="password" id="adminKey" placeholder="Enter Admin Key">
            </div>
            <button onclick="login()">LOGIN</button>
        </div>

        <div id="dashboardSection" style="display:none;">
            <div style="display: flex; gap: 20px;">
                <div style="flex: 2;">
                    <h2>Managed Servers</h2>
                    <div id="serverList"></div>
                </div>
                <div style="flex: 1; border-left: 1px solid #333; padding-left: 20px;">
                    <h2>License Management</h2>
                    <div class="card" style="background:#252525; padding:15px; border-radius:5px;">
                        <h3>Generate New Token</h3>
                        <div class="form-group">
                            <label>Duration</label>
                            <select id="licMonths">
                                <option value="1">1 Month</option>
                                <option value="2">2 Months</option>
                                <option value="3">3 Months</option>
                                <option value="6">6 Months</option>
                                <option value="12">1 Year</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Note (Optional)</label>
                            <input type="text" id="licNote" placeholder="Buyer Name etc.">
                        </div>
                        <button onclick="generateLicense()">GENERATE TOKEN</button>
                    </div>

                    <h3>Active Licenses</h3>
                    <div id="licenseList" style="max-height: 400px; overflow-y: auto;"></div>
                </div>
            </div>

            <br>
            <a href="index.html" style="color:#aaa;">&larr; Back to Installer</a>
        </div>
    </div>

    <!-- Stats Modal -->
    <div id="statsModal">
        <div id="statsContent">
            <h2>Server Monitoring</h2>
            <pre id="monitorOutput" style="color:#0f0; background:#000; padding:10px; overflow-x:auto;"></pre>

            <h3>Token Management</h3>
            <div class="form-group">
                 <input type="text" id="newToken" placeholder="New Token">
                 <input type="number" id="newOwnerId" placeholder="PIN (Owner ID)">
                 <button onclick="addToken()" style="width:auto; padding:8px;">Add Token</button>
            </div>

            <button onclick="closeModal()" style="background:#555;">CLOSE</button>
        </div>
    </div>

    <script>
        const API_URL = '/api';
        let adminKey = '';

        async function login() {
            const key = document.getElementById('adminKey').value.trim();
            // Verify Key by fetching servers
            const res = await fetch(`${API_URL}/servers`, {
                headers: { 'x-admin-key': key }
            });

            if (res.ok) {
                adminKey = key;
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('dashboardSection').style.display = 'block';
                const servers = await res.json();
                renderServers(servers);
            } else {
                alert('Invalid Admin Key!');
            }
        }

        async function loadServers() {
            const res = await fetch(`${API_URL}/servers`, {
                 headers: { 'x-admin-key': adminKey }
            });
            if (res.ok) {
                const servers = await res.json();
                renderServers(servers);
            }
            loadLicenses();
        }

        async function loadLicenses() {
            const res = await fetch(`${API_URL}/admin/licenses`, {
                 headers: { 'x-admin-key': adminKey }
            });
            if (res.ok) {
                const licenses = await res.json();
                renderLicenses(licenses);
            }
        }

        async function generateLicense() {
            const months = document.getElementById('licMonths').value;
            const note = document.getElementById('licNote').value;

            const res = await fetch(`${API_URL}/admin/generate-license`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-admin-key': adminKey
                },
                body: JSON.stringify({ months, note })
            });

            if(res.ok) {
                alert('License Generated!');
                loadLicenses();
            } else {
                alert('Error generating license');
            }
        }

        function renderLicenses(licenses) {
            const list = document.getElementById('licenseList');
            list.innerHTML = '';
            // Show Unused first
            licenses.sort((a,b) => (a.is_used === b.is_used) ? 0 : a.is_used ? 1 : -1);

            licenses.forEach(l => {
                const div = document.createElement('div');
                div.style.borderBottom = '1px solid #333';
                div.style.padding = '10px 0';
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <code style="color:${l.is_used ? '#888' : '#0f0'}; font-weight:bold; font-size:1.1rem;">${l.token}</code>
                        <span style="font-size:0.8rem; background:${l.is_used ? '#444' : '#28a745'}; padding:2px 5px; border-radius:3px;">${l.is_used ? 'USED' : 'NEW'}</span>
                    </div>
                    <div style="font-size:0.8rem; color:#aaa; margin-top:5px;">
                        Duration: ${l.months} Month(s)<br>
                        ${l.note ? `Note: ${l.note}<br>` : ''}
                        ${l.is_used ? `Used By: ${l.used_by_domain}` : ''}
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function renderServers(servers) {
            const list = document.getElementById('serverList');
            list.innerHTML = '';

            servers.forEach(s => {
                const div = document.createElement('div');
                div.className = 'server-card';

                const statusColor = s.status === 'expired' ? 'red' : 'inherit';
                const expiryInfo = s.expires_at ? `<br><span style="color:${statusColor}">Expires: ${s.expires_at}</span>` : '';

                div.innerHTML = `
                    <div>
                        <strong>${s.domain}</strong> (${s.ip})
                        ${expiryInfo}
                        <br>
                        <small style="color:#888;">Installed: ${new Date(s.installed_at).toLocaleString()}</small>
                    </div>
                    <div>
                        <button class="btn-info" onclick="monitorServer(${s.id})">Monitor</button>
                        <button class="btn-danger" onclick="deleteServer(${s.id})">Delete</button>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        async function deleteServer(id) {
            if(!confirm('Are you sure?')) return;
            await fetch(`${API_URL}/servers/${id}`, {
                method: 'DELETE',
                headers: { 'x-admin-key': adminKey }
            });
            loadServers();
        }

        let currentServerId = null;

        async function monitorServer(id) {
            currentServerId = id;
            document.getElementById('statsModal').style.display = 'flex';
            document.getElementById('monitorOutput').innerText = 'Fetching data...';

            const res = await fetch(`${API_URL}/monitor`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-admin-key': adminKey
                },
                body: JSON.stringify({ id })
            });
            if (!res.ok) return alert('Error fetching data');
            const data = await res.json();
            document.getElementById('monitorOutput').innerText = data.raw || JSON.stringify(data, null, 2);
        }

        async function addToken() {
            const token = document.getElementById('newToken').value;
            const ownerId = document.getElementById('newOwnerId').value;
            if(!token || !ownerId) return alert('Fill all fields');

            const res = await fetch(`${API_URL}/token`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-admin-key': adminKey
                },
                body: JSON.stringify({
                    id: currentServerId,
                    action: 'add',
                    tokenData: { token, owner_id: ownerId }
                })
            });
            const data = await res.json();
            if(data.success) {
                alert('Token Added!');
                document.getElementById('monitorOutput').innerText += `\n[Success] Token ${token} added.`;
            } else {
                alert('Error adding token');
            }
        }

        function closeModal() {
            document.getElementById('statsModal').style.display = 'none';
        }
    </script>
</body>
</html>
